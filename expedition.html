<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Exp√©dition - DHL</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
    body { margin: 0; font-family: Arial, sans-serif; background: #fff; }
    header { background: #ffcc00; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
    .logo { color: #cc0000; font-size: 26px; font-weight: bold; }
    .btn-retour { background-color: #cc0000; color: #fff; padding: 8px 14px; border: none; border-radius: 6px; text-decoration: none; font-size: 14px; }
    .container { padding: 20px; }
    h2 { color: #cc0000; font-size: 24px; }
    form { margin-top: 20px; }
    input, select, textarea { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 5px; }
    button { background-color: #cc0000; color: white; padding: 10px 16px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
    button:hover { background-color: #a80000; }
  </style>
</head>
<body>
<script>
const motDePasse = prompt("üîê Entrez le mot de passe administrateur :");
document.getElementById("debug").innerText += "‚úÖ Client Supabase initialis√©\n";
if (motDePasse !== "91158846") {
  alert("Mot de passe incorrect !");
  window.location.href = "index.html";
}

function logDebug(msg) {
  document.getElementById("debug").innerText += msg + "\n";
}

</script>
<header>
<div class="logo">DHL</div>
<a class="btn-retour" href="index.html">Accueil</a>
<a class="btn-retour" href="admin.html">Admin</a></header>
<div class="container">
<h2>Nouvelle exp√©dition</h2>
<form id="form-expedition">
<input id="code" placeholder="Code de suivi" required="" type="text"/>
<input id="expediteur" placeholder="Exp√©diteur" required="" type="text"/>
<input id="destinataire" placeholder="Destinataire" required="" type="text"/>
<input id="adresse" placeholder="Adresse de livraison" required="" type="text"/>
<input id="colis" placeholder="Contenu du colis" required="" type="text"/>
<input id="date_envoi" required="" type="datetime-local"/>
<input id="date_arrivee" required="" type="datetime-local"/>
<select id="trajet">
<option value="Prise en charge">Prise en charge</option>
<option value="En transit">En transit</option>
<option value="Arriv√© √† la poste">Arriv√© √† la poste</option>
</select>
<input id="photos" multiple="" type="file"/>
<button type="submit">Enregistrer l'exp√©dition</button>
<div id="debug" style="background:#ffe0e0; color:#900; padding:10px; margin-top:20px; font-family:monospace;"></div>
<div id="success-message" style="display:none; color:green; margin-top:10px;">‚úÖ Exp√©dition enregistr√©e avec succ√®s !</div>
</form>
</div>

<script src="client.min.js">
function logDebug(msg) {
  document.getElementById("debug").innerText += msg + "\n";
}

</script><script>
  const client = client.createClient(
    'https://lyzovuebqyomvffqekca.client.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx5em92dWVicXlvbXZmZnFla2NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MzExMTYsImV4cCI6MjA2NDIwNzExNn0.9eJonpo22P_k5a_vJMuVrH4XjzTwK2T08c8tk4uvQDU'
  );

  async function enregistrer() {
    document.getElementById("debug").innerText += "‚û° Fonction enregistrer appel√©e\n";
    const code = document.getElementById('code').value.trim();
    const expediteur = document.getElementById('expediteur').value.trim();
    const destinataire = document.getElementById('destinataire').value.trim();
    const adresse = document.getElementById('adresse').value.trim();
    const colis = document.getElementById('colis').value.trim();
    const date_envoi = document.getElementById('date_envoi').value;
    const date_arrivee = document.getElementById('date_arrivee').value;
    const trajet = document.getElementById('trajet').value;
    const fichiers = document.getElementById('photos').files;

    if (!code || !expediteur || !destinataire || !adresse || !colis || !date_envoi || !date_arrivee || !trajet) {
    logDebug("‚ùó Champs manquants. Annulation.");
      alert("Veuillez remplir tous les champs obligatoires.");
      return;
    }

    logDebug("üì¶ D√©but de l‚Äôupload des fichiers...");
    let photoUrls = [];
    for (let i = 0; i < fichiers.length; i++) {
      const fichier = fichiers[i];
      const { data, error: uploadError } = await client.storage
        .from("colis")
        .upload(`${code}/${fichier.name}`, fichier, {
          cacheControl: "3600",
          upsert: true
        });

      logDebug("‚ùå Erreur lors de l‚Äôupload de " + fichier.name);
    if (uploadError) {
        alert("Erreur upload image : " + uploadError.message);
        return;
      }

      const { data: urlData } = client.storage
        .from("colis")
        .getPublicUrl(`${code}/${fichier.name}`);

      photoUrls.push(urlData.publicUrl);
    }

    logDebug("üì® Insertion dans la base Supabase...");
    const { error } = await client.from("expeditions").insert([{
      code, expediteur, destinataire, adresse, colis, date_envoi, date_arrivee, trajet, photos: photoUrls
    }]);

    if (error) {
    logDebug("‚ùå Erreur enregistrement : " + error.message);
      alert("Erreur enregistrement : " + error.message);
    } else {
      const msg = document.getElementById("success-message");
      logDebug("‚úÖ Exp√©dition enregistr√©e avec succ√®s !");
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 5000);
    }
  }

function logDebug(msg) {
  document.getElementById("debug").innerText += msg + "\n";
}

</script>
<script>
document.getElementById("form-expedition").addEventListener("submit", function(event) {
  event.preventDefault();
  enregistrer();
});

function logDebug(msg) {
  document.getElementById("debug").innerText += msg + "\n";
}

</script>
</body>

</html>
